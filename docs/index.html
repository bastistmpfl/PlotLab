<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlotLab - SVG to G-Code Converter</title>
    <link rel="icon" type="image/svg+xml" href="favicon.png">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/import-dialog.css">
    <link rel="stylesheet" href="css/image-import-dialog.css">
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-content">
                <h1>PlotLab</h1>
                
                <!-- SVG List -->
                <section class="panel">
                    <h2>SVG Files</h2>
                    <button id="btn-import" class="btn--primary">Import SVG/Image</button>
                    <input type="file" id="file-input" accept=".svg,.png,.jpg,.jpeg,.gif" class="visually-hidden">
                    <ul id="svg-list" class="svg-list"></ul>
                </section>

                <!-- Transform Controls -->
                <section class="panel" id="transform-panel">
                    <h2>Transform</h2>
                    <div class="form__group">
                        <label for="pos-x">Position X (mm)</label>
                        <input type="number" id="pos-x" step="0.1" value="0">
                    </div>
                    <div class="form__group">
                        <label for="pos-y">Position Y (mm)</label>
                        <input type="number" id="pos-y" step="0.1" value="0">
                    </div>
                    <div class="form__group">
                        <label for="scale">Scale (%)</label>
                        <input type="number" id="scale" step="1" value="100" min="1">
                    </div>
                    <div class="form__group">
                        <label for="rotation">Rotation (¬∞)</label>
                        <input type="number" id="rotation" step="1" value="0">
                    </div>
                    <div class="form__group">
                        <label>Size (mm)</label>
                        <div id="svg-size" class="size-display">-</div>
                    </div>
                </section>

                <!-- Settings -->
                <section class="panel">
                    <fieldset>
                        <legend>Settings</legend>
                        <div class="form__group">
                            <label for="bed-width">Bed Width (mm)</label>
                            <input type="number" id="bed-width" value="256" min="1">
                        </div>
                        <div class="form__group">
                            <label for="bed-height">Bed Height (mm)</label>
                            <input type="number" id="bed-height" value="256" min="1">
                        </div>
                        <div class="form__group">
                            <label for="pen-up-z">Pen Up Z (mm)</label>
                            <input type="number" id="pen-up-z" value="0.6" step="0.1">
                        </div>
                        <div class="form__group">
                            <label for="sheet-height">Sheet Height (mm)</label>
                            <input type="number" id="sheet-height" value="0.15" step="0.01">
                        </div>
                        <div class="form__group">
                            <label for="pen-offset-x">Pen Offset X (mm)</label>
                            <input type="number" id="pen-offset-x" value="0" step="0.1">
                        </div>
                        <div class="form__group">
                            <label for="pen-offset-y">Pen Offset Y (mm)</label>
                            <input type="number" id="pen-offset-y" value="0" step="0.1">
                        </div>
                        <div class="form__group">
                            <label for="pen-offset-z">Pen Offset Z (mm)</label>
                            <input type="number" id="pen-offset-z" value="0" step="0.1">
                        </div>
                        <button id="btn-apply-settings" class="btn--secondary">Apply Settings</button>
                    </fieldset>
                </section>

                <!-- Exclusion Zones / Sperrbereiche -->
                <section class="panel">
                    <h2>Exclusion Zones</h2>
                    <button id="btn-add-zone" class="btn--primary">Add Zone</button>
                    <ul id="zone-list" class="zone-list"></ul>
                </section>

                <!-- Presets -->
                <section class="panel">
                    <h2>Presets</h2>
                    <button id="btn-save-preset" class="btn--primary">Save Current</button>
                    <button id="btn-load-preset" class="btn--secondary">Load Preset</button>
                    <ul id="preset-list" class="preset-list"></ul>
                </section>

                <!-- Project Management -->
                <section class="panel">
                    <h2>Project</h2>
                    <button id="btn-save-project" class="btn--primary">üíæ Save Project</button>
                    <button id="btn-load-project" class="btn--secondary">üìÅ Load Project</button>
                    <button id="btn-export-project" class="btn--secondary">‚Üì Export JSON</button>
                    <button id="btn-import-project" class="btn--secondary">‚Üë Import JSON</button>
                    <input type="file" id="project-file-input" accept=".json,.plotlab.json" style="display: none;">
                </section>

                <!-- G-Code Export -->
                <section class="panel">
                    <h2>G-Code</h2>
                    <div class="form__group">
                        <label>
                            <input type="checkbox" id="optimize-paths" checked>
                            Optimize path order (reduce travel distance)
                        </label>
                    </div>
                    <div class="form__group">
                        <label for="feed-rate">Draw Feed Rate (mm/min)</label>
                        <input type="number" id="feed-rate" value="3000" min="1" step="100">
                    </div>
                    <div class="form__group">
                        <label for="travel-feed-rate">Travel Feed Rate (mm/min)</label>
                        <input type="number" id="travel-feed-rate" value="9000" min="1" step="100">
                    </div>
                    <div class="form__group">
                        <label for="gcode-header">Header G-code</label>
                        <textarea id="gcode-header">; ========== PlotLab - generated G-code  ==========

; ========== machine: P1S ==========

; ========== startup sequence ==========
; heating: off
M106 P1 S0 ; turn off part fan
M106 P2 S0 ; turn off AUX fan
M106 P3 S0 ; turn off Chamber fan

G28 ; home all axes

; ========== MANUAL STEP NEEDED NOW ==========

M106 P1 S255 ; turn on part fan
M400 U1 ; wait for user interaction
M106 P1 S0 ; turn off part fan

; ATTACH THE PEN ADAPTER NOW AND PRESS CONTINUE

; ========== MANUAL STEP NEEDED NOW ==========
; coordinates settings
G90 ; absolute coords

; progress bar
M73 P0 R0 ; clear progress bar

G0 Z{nozzleUpZ} F{travelFeedRate} ; pen up (safe height, nozzle adjusted for pen offset)</textarea>
                        <div class="form-hint">Tokens: {penUpZ} {nozzleUpZ} {sheetHeight} {feedRate} {travelFeedRate} {offsetX} {offsetY} {offsetZ} {bedWidth} {bedHeight} {timestamp}</div>
                    </div>
                    <div class="form__group">
                        <label for="gcode-footer">Footer G-code</label>
                        <textarea id="gcode-footer">; ========== end sequence ==========
; progress complete
M73 P100 R0 ; set progress bar to 100%

; Go to up left corner and end
G0 X0 Y{bedHeight} Z100
; FINISHED</textarea>
                    </div>
                    <button id="btn-export-gcode" class="btn--primary">Export G-Code</button>
                    <button id="btn-view-gcode" class="btn--secondary">View G-Code</button>
                </section>
            </div>
        </aside>

        <!-- Main 3D Preview Area -->
        <main class="main-content">
            <div class="toolbar">
                <h2>3D Preview</h2>
                <div class="toolbar__controls">
                    <button id="btn-theme-toggle" class="toolbar__btn" title="Toggle Theme">üåô Dark</button>
                    <button id="btn-undo" class="toolbar__btn" title="Undo (Ctrl+Z)" disabled>‚Ü∂ Undo</button>
                    <button id="btn-redo" class="toolbar__btn" title="Redo (Ctrl+Shift+Z)" disabled>‚Ü∑ Redo</button>
                    <button id="btn-reset-camera" class="toolbar__btn">Reset Camera</button>
                    <button id="btn-toggle-grid" class="toolbar__btn">Toggle Grid</button>
                </div>
            </div>
            <!-- Collision Warning Banner -->
            <div id="collision-warning" class="collision-warning" style="display: none;">
                <div class="collision-warning__icon">‚ö†Ô∏è</div>
                <div class="collision-warning__content">
                    <strong>Collision Detected!</strong>
                    <span id="collision-message"></span>
                </div>
                <button id="btn-dismiss-warning" class="collision-warning__dismiss">‚úï</button>
            </div>
            <div id="canvas-container">
                <canvas id="preview-canvas"></canvas>
            </div>
        </main>
    </div>

    <!-- G-Code Viewer Modal -->
    <div id="gcode-modal" class="modal" role="dialog" aria-modal="true">
        <div class="modal-content">
            <div class="modal-header">
                <h2>G-Code Viewer</h2>
                <button id="modal-close" aria-label="Close">&times;</button>
            </div>
            <div id="validation-panel" class="validation-panel" style="display:none;">
                <div class="validation-summary" id="validation-summary"></div>
                <div class="validation-details" id="validation-details"></div>
            </div>
            <div class="modal-body">
                <textarea id="gcode-content"></textarea>
            </div>
            <div class="modal-footer">
                <button id="btn-copy-gcode" class="btn--secondary">Copy to Clipboard</button>
                <button id="btn-download-gcode" class="btn--primary">Download G-Code</button>
            </div>
        </div>
    </div>

    <!-- Exclusion Zone Modal -->
    <div id="zone-modal" class="modal" role="dialog" aria-modal="true">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Exclusion Zone</h2>
                <button id="zone-modal-close" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form__group">
                    <label for="zone-name">Name</label>
                    <input type="text" id="zone-name" placeholder="Zone Name">
                </div>
                <div class="form__group">
                    <label for="zone-x">X Position (mm)</label>
                    <input type="number" id="zone-x" value="0" step="1">
                </div>
                <div class="form__group">
                    <label for="zone-y">Y Position (mm)</label>
                    <input type="number" id="zone-y" value="0" step="1">
                </div>
                <div class="form__group">
                    <label for="zone-width">Width (mm)</label>
                    <input type="number" id="zone-width" value="50" step="1" min="1">
                </div>
                <div class="form__group">
                    <label for="zone-height">Height (mm)</label>
                    <input type="number" id="zone-height" value="50" step="1" min="1">
                </div>
            </div>
            <div class="modal-footer">
                <button id="zone-modal-cancel" class="btn--secondary">Cancel</button>
                <button id="zone-modal-add" class="btn--primary">Add Zone</button>
            </div>
        </div>
    </div>

    <!-- Preset Save Modal -->
    <div id="preset-save-modal" class="modal" role="dialog" aria-modal="true">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Save Preset</h2>
                <button id="preset-save-modal-close" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form__group">
                    <label for="preset-name">Preset Name</label>
                    <input type="text" id="preset-name" placeholder="My Preset">
                </div>
            </div>
            <div class="modal-footer">
                <button id="preset-save-modal-cancel" class="btn--secondary">Cancel</button>
                <button id="preset-save-modal-save" class="btn--primary">Save</button>
            </div>
        </div>
    </div>

    <!-- Preset Load Modal -->
    <div id="preset-load-modal" class="modal" role="dialog" aria-modal="true">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Load Preset</h2>
                <button id="preset-load-modal-close" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body">
                <ul id="preset-load-list" class="preset-grid"></ul>
            </div>
            <div class="modal-footer">
                <button id="preset-load-modal-close-btn" class="btn--secondary">Close</button>
            </div>
        </div>
    </div>

    <!-- Project Save Modal -->
    <div id="project-save-modal" class="modal" role="dialog" aria-modal="true">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üíæ Save Project</h2>
                <button id="project-save-modal-close" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form__group">
                    <label for="project-name">Project Name</label>
                    <input type="text" id="project-name" placeholder="My PlotLab Project">
                </div>
                <p style="font-size: 0.9em; color: var(--color-text-secondary); margin-top: 10px;">
                    Saves all SVGs, settings, exclusion zones, and transformations.
                </p>
            </div>
            <div class="modal-footer">
                <button id="project-save-modal-cancel" class="btn--secondary">Cancel</button>
                <button id="project-save-modal-save" class="btn--primary">Save</button>
            </div>
        </div>
    </div>

    <!-- Project Load Modal -->
    <div id="project-load-modal" class="modal" role="dialog" aria-modal="true">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìÅ Load Project</h2>
                <button id="project-load-modal-close" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body">
                <ul id="project-load-list" class="project-list"></ul>
                <p id="project-no-saved" style="font-size: 0.9em; color: var(--color-text-secondary); text-align: center; padding: 20px; display: none;">
                    No saved projects. Save your current work to see it here.
                </p>
            </div>
            <div class="modal-footer">
                <button id="project-load-modal-close-btn" class="btn--secondary">Close</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/examples/jsm/controls/OrbitControls.js": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/OrbitControls.js",
            "three/examples/jsm/lines/Line2.js": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/lines/Line2.js",
            "three/examples/jsm/lines/LineMaterial.js": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/lines/LineMaterial.js",
            "three/examples/jsm/lines/LineGeometry.js": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/lines/LineGeometry.js"
        }
    }
    </script>
    <script type="module" src="js/app.js"></script>
</body>
</html>
